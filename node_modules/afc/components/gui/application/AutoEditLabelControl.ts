/* global AFC */
/* global customElements */
namespace AFC.gui {
    const _timeout = Symbol();
    
    function _generate(control: AfcAutoEditLabelControl) {
        (control[_timeout] !== void 0) || (control[_timeout] = setTimeout(function() {
            let query       = $(control),
                div: HTMLDivElement = document.createElement('div'),
                newFocus    = null;

            if (control.editionMode) {
                let input = document.createElement('input')

                input.type          = 'text';
                input.style.width   = '100%';
                input.style.height  = control.style.height;
                input.value         = control.value;
                newFocus            = input;

                 $(input).change(function() {
                    AFC.gui._dispatchEvent(control, 'change', {detail: control.value = this.value});
                    });

                div.appendChild(input);
            }
            else {
                let span        = document.createElement('span'),
                    divButton   = document.createElement('div'),
                    style = div.style;

                divButton.className = 'editButton';
                span.innerHTML      = control.value;

                style.display = 'flex';
                style.flexDirection = 'row';
                style.alignItems = 'flex-end';
                div.appendChild(divButton);
                div.appendChild(span);
            }
            div.style.cursor = 'pointer';
            query.empty();
            control.appendChild(div);
            if (newFocus)
                newFocus.focus();
            delete control[_timeout];
        }, 0));
    }

    
    export class AfcAutoEditLabelControl extends AfcGuiElement {
        private _value: string;
        private _editionMode: boolean;
        /** @internal */
        public [_timeout]: number;
        public static observedAttributes = AfcGuiElement.observedAttributes.concat(['editionMode']);

        constructor() {
            super();
            this._editionMode = false;
            this._value = '';
            this.addEventListener('click', function(this: AfcAutoEditLabelControl, event) {
                if (!this.editionMode) {
                    this.editionMode = true;
                }
            }, true);
            _generate(this);
        }

        public get value(): string {
            return this._value;
        }
        
        public set value(value: string) {
            this._value = value;
            _generate(this);
        }

        public get editionMode(): boolean {
            return this._editionMode;
        }
        
        public set editionMode(value: boolean) {
            let showEdition = !!value;

            if (showEdition !== this._editionMode) {
                this._editionMode = showEdition;
                _generate(this);
            }
        }
    }
        
    registerElement("afc-gui-auto-edit-label-control", AfcAutoEditLabelControl);
}